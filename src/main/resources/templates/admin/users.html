<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление пользователями - Система хранения и анализа данных с полей</title>
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style_fields.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <style>
        /* Специальные стили для страницы пользователей */
        .user-status-active {
            color: #28a745;
        }

        .user-status-inactive {
            color: #dc3545;
        }

        /* Увеличиваем ширину таблицы */
        .table-container {
            width: 90%;
            max-width: 1200px;
        }

        /* Вертикальное расположение кнопок */
        .action-buttons {
            display: flex;
            flex-direction: column; /* Кнопки друг над другом */
            align-items: center;
            gap: 8px; /* Отступ между кнопками */
            width: 100%; /* Важно: 100% ширина контейнера */
        }

        /* Фиксированная ширина и высота для всех кнопок действий */
        .action-btn {
            width: 100% !important; /* Важно: 100% ширина кнопок */
            min-width: 140px;
            height: 36px; /* Фиксированная высота кнопок */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 !important; /* Убираем встроенные отступы */
            white-space: nowrap; /* Избегаем переноса текста */
            padding: 0.375rem 0.75rem; /* Стандартные отступы внутри кнопки */
        }

        /* Убираем отступы и границы у формы */
        .action-form {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Стили для пагинации */
        .custom-pagination {
            margin-top: 20px;
            width: auto;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Центрирование текста в ячейках */
        table th, table td {
            text-align: center !important;
            vertical-align: middle !important;
            padding: 12px 8px; /* Увеличенные отступы в ячейках */
        }

        /* Стили для секции ролей */
        .roles-cell {
            min-width: 120px; /* Минимальная ширина для ячейки с ролями */
        }

        /* Улучшенные стили для статуса */
        .status-icon {
            margin-right: 5px;
            font-size: 16px;
            vertical-align: middle;
        }

        /* Вертикальное центрирование в ячейке действий */
        .actions-cell {
            padding: 12px 6px !important;
            vertical-align: middle !important;
            width: 150px !important;
        }
    </style>
</head>
<body>
<header>
    <h1>Система хранения и анализа данных с полей</h1>
    <h2>Панель администратора - Управление пользователями</h2>
</header>

<div id="nav-placeholder"></div>

<!-- Исправление проблемы с canEdit - всегда true для админа -->
<input type="hidden" id="user-can-edit" value="true" />

<div class="container-fluid mt-4">
    <div class="table-container mx-auto">
        <table id="users-table" class="display table table-striped">
            <thead>
            <tr>
                <th>Имя пользователя</th>
                <th>Email</th>
                <th>Полное имя</th>
                <th>Роли</th>
                <th>Статус</th>
                <th style="width: 150px;">Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}">
                <td th:text="${user.username}"></td>
                <td th:text="${user.email}"></td>
                <td th:text="${user.fullName}"></td>
                <td class="roles-cell">
                    <span th:each="role : ${user.roles}" class="badge badge-primary mr-1" th:text="${role}"></span>
                </td>
                <td>
                        <span th:if="${user.enabled}" class="user-status-active">
                            <i class="fas fa-check-circle status-icon"></i> Активен
                        </span>
                    <span th:unless="${user.enabled}" class="user-status-inactive">
                            <i class="fas fa-times-circle status-icon"></i> Неактивен
                        </span>
                </td>
                <td class="actions-cell">
                    <div class="action-buttons">
                        <a th:href="@{/admin/users/{id}(id=${user.id})}" class="btn btn-info btn-sm action-btn">
                            <i class="fas fa-eye"></i> Подробнее
                        </a>
                        <form th:action="@{/admin/users/{id}/toggle-status(id=${user.id})}" method="post" class="action-form">
                            <button type="submit" class="btn btn-warning btn-sm action-btn">
                                <i class="fas fa-power-off"></i>
                                <span th:if="${user.enabled}">Деактивировать</span>
                                <span th:unless="${user.enabled}">Активировать</span>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Кастомная пагинация по аналогии с предоставленным CSS -->
        <div class="custom-pagination">
            <ul class="pagination">
                <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                    <a class="page-link" th:href="@{/admin/users(page=0, size=${size})}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                    <a class="page-link" th:href="@{/admin/users(page=${currentPage - 1}, size=${size})}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage ? 'active' : ''}">
                    <a class="page-link" th:href="@{/admin/users(page=${i}, size=${size})}" th:text="${i + 1}"></a>
                </li>

                <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" th:href="@{/admin/users(page=${currentPage + 1}, size=${size})}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" th:href="@{/admin/users(page=${totalPages - 1}, size=${size})}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            </ul>

            <!-- Информация о страницах - ИСПРАВЛЕННАЯ ВЕРСИЯ -->
            <div class="pagination-info mt-2 text-center">
                Записи с <span th:text="${currentPage * size + 1}"></span> до
                <span th:text="${(currentPage + 1) * size < totalItems ? (currentPage + 1) * size : totalItems}"></span>
                из <span th:text="${totalItems}"></span> записей
            </div>
        </div>

        <!-- Кнопка возврата на главную -->
        <div class="text-center mt-4">
            <a href="/fields-page" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Вернуться на главную
            </a>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="/js/common.js"></script>
<script>
    $(function(){
        $("#nav-placeholder").load("/nav.html", function() {
            highlightActiveNavItem();
        });

        // Инициализация DataTables
        $('#users-table').DataTable({
            paging: false, // Отключаем встроенную пагинацию, т.к. используем свою
            searching: true,
            ordering: true,
            info: false, // Отключаем информацию о количестве записей
            autoWidth: false, // Отключаем автоматическую ширину колонок
            columnDefs: [
                { "width": "15%", "targets": 0 }, // Имя пользователя
                { "width": "20%", "targets": 1 }, // Email
                { "width": "20%", "targets": 2 }, // Полное имя
                { "width": "10%", "targets": 3 }, // Роли
                { "width": "10%", "targets": 4 }, // Статус
                { "width": "150px", "targets": 5 }  // Действия с фиксированной шириной
            ],
            language: {
                "processing": "Подождите...",
                "search": "Поиск:",
                "lengthMenu": "Показать _MENU_ записей",
                "info": "Записи с _START_ до _END_ из _TOTAL_ записей",
                "infoEmpty": "Записи с 0 до 0 из 0 записей",
                "infoFiltered": "(отфильтровано из _MAX_ записей)",
                "infoPostFix": "",
                "loadingRecords": "Загрузка записей...",
                "zeroRecords": "Записи отсутствуют.",
                "emptyTable": "В таблице отсутствуют данные"
            }
        });

        // Убедимся, что кнопки имеют одинаковую ширину
        setTimeout(function() {
            // Устанавливаем одинаковую ширину для всех кнопок
            var maxWidth = 0;
            $('.action-btn').each(function() {
                if ($(this).outerWidth() > maxWidth) {
                    maxWidth = $(this).outerWidth();
                }
            });

            if (maxWidth > 0) {
                $('.action-btn').css('width', maxWidth + 'px');
            }
        }, 100);
    });

    function highlightActiveNavItem() {
        var url = window.location.href.split('#')[0];
        var links = document.querySelectorAll('.nav-item a');
        links.forEach(function(link) {
            if (url.includes(link.getAttribute('href'))) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    function canUserEdit() {
        return document.getElementById('user-can-edit') !== null &&
               document.getElementById('user-can-edit').value === 'true';
    }
</script>
</body>
</html>